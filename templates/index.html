<!-- templates/index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PrinceTheProgrammer's FileDrop</title>
    <link rel="apple-touch-icon" sizes="180x180" href="/static/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/static/favicon-16x16.png">
    <link rel="manifest" href="/static/site.webmanifest">
    <link rel="stylesheet" href="/static/shadcn-style.css">
</head>
<body>
    <main>
        <div class="card">
            <div class="space-y-6">
                <div class="card-header">
                    <h1 class="card-title">PrinceTheProgrammer's Archive</h1>
                </div>

                <div class="card-content">
                    <form action="/upload" method="post" enctype="multipart/form-data" class="upload-form">
                        <input class="input" type="file" name="file" required>
                        <button type="submit" class="btn btn-primary">Upload</button>
                    </form>
                </div>

                <div class="card-content">
                    <div class="table-wrapper">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Filename</th>
                                    <th>Uploaded On</th>
                                    <th class="text-right">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {{if .}}
                                    {{range .}}
                                    <tr id="file-row-{{.Filename}}">
                                        <td data-label="Filename" class="filename-cell">
                                            <a href="/files/{{.Filename}}">{{.Filename}}</a>
                                            <div id="share-link-display-{{.Filename}}" class="share-link-display">
                                                {{if .ShareToken}}
                                                    Share link: <a href="/s/{{.ShareToken}}" target="_blank">/s/{{.ShareToken}}</a>
                                                {{end}}
                                            </div>
                                        </td>
                                        <td data-label="Uploaded On">{{.UploadDate.Format "Jan 02, 2006"}}</td>
                                        <td data-label="Action" class="text-right actions-cell">
                                            <div class="actions-container" id="actions-{{.Filename}}">
                                                {{if .ShareToken}}
                                                    <form action="/unshare/{{.Filename}}" method="post" onsubmit="return confirm('Are you sure you want to remove the share link?');">
                                                        <button type="submit" class="btn btn-secondary">Unshare</button>
                                                    </form>
                                                {{else}}
                                                    <button class="btn btn-secondary" onclick="toggleShareForm('{{.Filename}}')">Share</button>
                                                {{end}}
                                                <form action="/delete/{{.Filename}}" method="post" onsubmit="return confirm('Are you sure?');">
                                                    <button type="submit" class="btn btn-destructive">Delete</button>
                                                </form>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr id="share-form-{{.Filename}}" style="display: none;">
                                        <td colspan="3">
                                            <form onsubmit="handleShare(event, '{{.Filename}}')">
                                                <div class="share-form-inputs">
                                                    <input type="password" name="password" placeholder="Password (optional)" class="input">
                                                    <input type="number" name="expiry_days" placeholder="Expiry Days (optional)" class="input" min="0">
                                                    <input type="number" name="max_downloads" placeholder="Max Downloads (optional)" class="input" min="0">
                                                </div>
                                                <div class="text-right" style="margin-top: 1rem;">
                                                    <button type="submit" class="btn btn-primary">Create Link</button>
                                                </div>
                                            </form>
                                            <div id="share-link-container-{{.Filename}}" class="share-link-container" style="margin-top: 10px;"></div>
                                        </td>
                                    </tr>
                                    {{end}}
                                {{else}}
                                    <tr>
                                        <td colspan="3" style="text-align: center; color: var(--muted-foreground);">No files uploaded yet.</td>
                                    </tr>
                                {{end}}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>
    <script>
        function toggleShareForm(filename) {
            const formRow = document.getElementById('share-form-' + filename);
            const computedStyle = window.getComputedStyle(formRow);

            if (computedStyle.display === 'none') {
                const displayStyle = window.innerWidth < 640 ? 'block' : 'table-row';
                formRow.style.display = displayStyle;
            } else {
                formRow.style.display = 'none';
            }
        }

        async function handleShare(event, filename) {
            event.preventDefault();
            const form = event.target;
            const password = form.elements.password.value;
            const expiry_days = parseInt(form.elements.expiry_days.value, 10) || 0;
            const max_downloads = parseInt(form.elements.max_downloads.value, 10) || 0;

            const response = await fetch('/share/' + filename, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ password, expiry_days, max_downloads })
            });

            const resultContainer = document.getElementById('share-link-container-' + filename);
            if (response.ok) {
                const result = await response.json();
                
                // Update share link display
                const shareLinkDisplay = document.getElementById('share-link-display-' + filename);
                shareLinkDisplay.innerHTML = `Share link: <a href="${result.shareLink}" target="_blank">${result.shareLink}</a>`;

                // Update action buttons
                const actionsContainer = document.getElementById('actions-' + filename);
                actionsContainer.innerHTML = `
                    <form action="/unshare/${filename}" method="post" onsubmit="return confirm('Are you sure you want to remove the share link?');">
                        <button type="submit" class="btn btn-secondary">Unshare</button>
                    </form>
                    <form action="/delete/${filename}" method="post" onsubmit="return confirm('Are you sure?');">
                        <button type="submit" class="btn btn-destructive">Delete</button>
                    </form>
                `;

                // Hide the share form
                toggleShareForm(filename);
                form.reset();
                resultContainer.innerHTML = '';

            } else {
                const errorText = await response.text();
                resultContainer.innerHTML = `<p style="color: red;">Error: ${errorText}</p>`;
            }
        }
    </script>
</body>
</html>